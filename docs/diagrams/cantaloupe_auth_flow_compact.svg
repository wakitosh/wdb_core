<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="835" height="567" viewBox="0 0 835 567">
  <title>Drupal &amp; Cantaloupe Authorization Flow (Compact)</title>
  <defs>
    <style>
      .bg { fill: #ffffff; }
      .actor-box { fill: #f9fafb; stroke: #9ca3af; stroke-width: 1.5; rx: 8; }
      .drupal-box { fill: #f0f5ff; stroke: #4a85d6; }
      .title { font: 700 24px sans-serif; fill: #1f2937; }
      .actor-label { font: 600 16px sans-serif; fill: #111827; }
      .step-label { font: 700 18px sans-serif; fill: #4f46e5; }
      .desc { font: 14px sans-serif; fill: #374151; }
      .mono { font: 13px monospace; fill: #1f2937; }
      .arrow { stroke: #374151; stroke-width: 2; fill: none; }
      .arrow-ok { stroke: #16a34a; }
      .arrow-ng { stroke: #dc2626; }
      .icon-ok { fill: #16a34a; stroke: #ffffff; stroke-width: 2; }
      .icon-ng { fill: #dc2626; stroke: #ffffff; stroke-width: 2; }
    </style>
    <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#374151" />
    </marker>
    <marker id="arrowhead-ok" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#16a34a" />
    </marker>
    <marker id="arrowhead-ng" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#dc2626" />
    </marker>
  </defs>

  <rect width="835" height="567" class="bg"/>
  <text x="40" y="50" class="title">wdb_cantaloupe_auth: アクセス認可フロー</text>

  <!-- Actors -->
  <rect x="40" y="100" width="200" height="80" class="actor-box"/>
  <text x="65" y="145" class="actor-label">ユーザーブラウザ</text>

  <rect x="317.5" y="100" width="200" height="80" class="actor-box"/>
  <text x="338" y="145" class="actor-label">Cantaloupe Server</text>

  <rect x="595" y="100" width="200" height="80" class="actor-box drupal-box"/>
  <text x="653" y="145" class="actor-label">Drupal</text>

  <!-- Step 1: Request -->
  <text x="140" y="230" class="step-label">①</text>
  <path d="M 140 180 V 260" class="arrow" marker-end="url(#arrowhead)"/>
  <text x="40" y="285" class="desc">画像タイルを要求</text>
  <text x="40" y="305" class="mono">GET /iiif/2/{id}/...</text>
  <text x="40" y="325" class="desc">(Cookieも送信)</text>

  <!-- Step 2: Delegate & Check -->
  <text x="417.5" y="230" class="step-label">②</text>
  <path d="M 240 295 H 595" class="arrow" marker-end="url(#arrowhead)"/>
  <text x="290" y="280" class="desc">delegate.rb が認可を委譲</text>
  <text x="290" y="315" class="mono">POST /wdb/api/cantaloupe_auth</text>
  <text x="310" y="335" class="desc">{ cookies, identifier }</text>

  <!-- Step 3: Authorize -->
  <text x="695" y="230" class="step-label">③</text>
  <path d="M 695 180 V 360" class="arrow" marker-end="url(#arrowhead)"/>
  <text x="610" y="385" class="desc">セッションと権限を検証</text>
  <text x="610" y="405" class="mono">"View non-public WDB</text>
  <text x="610" y="422" class="mono"> gallery pages"</text>

  <!-- Step 4: Respond -->
  <path d="M 595 400 H 517.5" class="arrow" marker-end="url(#arrowhead)"/>
  <text x="417.5" y="380" class="step-label">④</text>
  <text x="470" y="415" class="desc">判定結果</text>
  <text x="450" y="435" class="mono">{ authorized: ... }</text>

  <!-- Step 5a: Authorized -->
  <path d="M 317.5 455 V 500" class="arrow arrow-ok" marker-end="url(#arrowhead-ok)"/>
  <path d="M 317.5 500 H 140" class="arrow arrow-ok" marker-end="url(#arrowhead-ok)"/>
  <circle cx="317.5" cy="478" r="15" class="icon-ok"/>
  <path d="M 311.5 480 l 4 4 l 8 -8" stroke="#fff" stroke-width="3" fill="none"/>
  <text x="170" y="525" class="desc">許可 → 200 OK (画像)</text>

  <!-- Step 5b: Forbidden -->
  <path d="M 517.5 455 V 500" class="arrow arrow-ng" marker-end="url(#arrowhead-ng)"/>
  <path d="M 517.5 500 H 140" class="arrow arrow-ng" marker-end="url(#arrowhead-ng)"/>
  <circle cx="517.5" cy="478" r="15" class="icon-ng"/>
  <path d="M 510 470.5 l 15 15 m 0 -15 l -15 15" stroke="#fff" stroke-width="3" fill="none"/>
  <text x="230" y="460" class="desc">不許可 → 403 Forbidden</text>
</svg>
