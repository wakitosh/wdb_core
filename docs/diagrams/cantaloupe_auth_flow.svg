<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="720" viewBox="0 0 1200 720">
  <defs>
    <style>
      .title { font: 700 22px sans-serif; fill: #1f2937; }
      .subtitle { font: 600 14px sans-serif; fill: #374151; }
      .label { font: 13px sans-serif; fill: #111827; }
      .mono { font: 12px monospace; fill: #111827; }
      .small { font: 11px sans-serif; fill: #374151; }
      .box { fill: #ffffff; stroke: #1f2937; stroke-width: 1.5; rx: 10; }
      .box-soft { fill: #f9fafb; stroke: #9ca3af; stroke-width: 1; rx: 8; }
      .note { fill: #eef2ff; stroke: #6366f1; stroke-width: 1; rx: 8; }
      .arrow { stroke: #111827; stroke-width: 1.6; fill: none; }
      .yes { stroke: #059669; }
      .no { stroke: #dc2626; }
      .line { stroke: #9ca3af; stroke-width: 1; stroke-dasharray: 5 5; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#111827" />
    </marker>
    <marker id="arrowheadGreen" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#059669" />
    </marker>
    <marker id="arrowheadRed" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#dc2626" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="36" y="48" class="title">Drupal × Cantaloupe 認可フロー（wdb_cantaloupe_auth）</text>
  <text x="36" y="72" class="small">画像アクセス時の delegate.rb による事前認可と、Drupal 側のセッション検証＋権限チェックの流れ</text>

  <!-- Swimlanes -->
  <line x1="0" y1="110" x2="1200" y2="110" class="line"/>
  <text x="60" y="100" class="subtitle">クライアント（ブラウザ）</text>
  <line x1="0" y1="300" x2="1200" y2="300" class="line"/>
  <text x="60" y="290" class="subtitle">Cantaloupe IIIF Image Server（delegate.rb）</text>
  <line x1="0" y1="540" x2="1200" y2="540" class="line"/>
  <text x="60" y="530" class="subtitle">Drupal（/wdb/api/cantaloupe_auth）</text>

  <!-- Client box -->
  <rect x="40" y="130" width="270" height="120" class="box"/>
  <text x="60" y="160" class="label">ブラウザ / IIIF ビューア</text>
  <text x="60" y="188" class="mono">GET /iiif/2/{identifier}/{region}/{size}/{rotation}/default.jpg</text>
  <text x="60" y="212" class="small">画像/タイルの取得要求（Cookie 同送）</text>

  <!-- Cantaloupe box -->
  <rect x="420" y="320" width="320" height="170" class="box"/>
  <text x="440" y="350" class="label">Cantaloupe Image Server</text>
  <rect x="440" y="362" width="280" height="110" class="box-soft"/>
  <text x="460" y="388" class="label">delegate.rb: pre_authorize</text>
  <text x="460" y="412" class="small">・info.json は無条件許可</text>
  <text x="460" y="432" class="small">・API エラー時は安全側（拒否）</text>

  <!-- Drupal box -->
  <rect x="820" y="560" width="330" height="130" class="box"/>
  <text x="840" y="590" class="label">Drupal API: /wdb/api/cantaloupe_auth</text>
  <rect x="840" y="602" width="290" height="70" class="note"/>
  <text x="860" y="628" class="small">セッション検証（Cookie → ログイン判定）</text>
  <text x="860" y="648" class="small">対象サブシステム権限: "View non-public WDB gallery pages" を確認</text>

  <!-- Arrows: Client -> Cantaloupe -->
  <path d="M 310 190 L 420 355" class="arrow" marker-end="url(#arrowhead)"/>
  <text x="320" y="210" class="small">画像リクエストを受領</text>

  <!-- Arrows: delegate.rb -> Drupal (POST) -->
  <path d="M 700 415 C 780 430, 800 560, 820 590" class="arrow" marker-end="url(#arrowhead)"/>
  <text x="730" y="450" class="mono">POST /wdb/api/cantaloupe_auth</text>
  <text x="730" y="470" class="small">payload: cookies[], identifier</text>

  <!-- Arrows: Drupal -> delegate.rb (authorized=true) -->
  <path d="M 820 620 C 780 560, 740 470, 620 450" class="arrow yes" marker-end="url(#arrowheadGreen)"/>
  <text x="650" y="520" class="mono">{ "authorized": true }</text>

  <!-- Arrows: delegate.rb -> Client (200 OK) -->
  <path d="M 520 355 C 420 250, 360 220, 310 220" class="arrow yes" marker-end="url(#arrowheadGreen)"/>
  <text x="370" y="260" class="small">許可 → 画像を返却（200）</text>

  <!-- Negative path: Drupal -> delegate.rb (authorized=false) -->
  <path d="M 980 690 C 740 690, 720 500, 680 460" class="arrow no" marker-end="url(#arrowheadRed)"/>
  <text x="740" y="660" class="mono">{ "authorized": false }</text>

  <!-- Negative path: delegate.rb -> Client (403) -->
  <path d="M 600 430 C 520 300, 420 250, 320 200" class="arrow no" marker-end="url(#arrowheadRed)"/>
  <text x="370" y="320" class="small">不許可 / エラー → 403</text>

  <!-- Legend -->
  <rect x="40" y="610" width="420" height="90" class="box-soft"/>
  <text x="60" y="640" class="small">凡例</text>
  <line x1="60" y1="655" x2="120" y2="655" class="arrow yes" marker-end="url(#arrowheadGreen)"/>
  <text x="130" y="660" class="small">許可フロー</text>
  <line x1="220" y1="655" x2="280" y2="655" class="arrow no" marker-end="url(#arrowheadRed)"/>
  <text x="290" y="660" class="small">拒否フロー</text>
  <text x="60" y="686" class="small">備考: info.json は常に許可。API失敗時は安全側（false）として拒否。</text>
</svg>
